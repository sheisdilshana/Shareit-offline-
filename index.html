<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Titanium Share</title>
<link rel="manifest" href="manifest.json">
<script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>

<style>
/* --- NATIVE APP DESIGN --- */
:root { --bg: #000; --panel: #1a1a1a; --accent: #00ff88; --text: #fff; }
body { background: var(--bg); color: var(--text); font-family: sans-serif; margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; user-select: none; }

header { padding: 15px; background: var(--panel); border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; -webkit-app-region: drag; }
h1 { margin:0; font-size:18px; color: var(--accent); letter-spacing: 1px; }
.status { font-size: 10px; background: #333; padding: 4px 8px; border-radius: 4px; }
.online { background: var(--accent); color: #000; font-weight: bold; }

/* LAYOUT */
#app { flex: 1; padding: 20px; display: flex; flex-direction: column; gap: 15px; overflow-y: auto; }

.card { background: var(--panel); padding: 20px; border-radius: 12px; border: 1px solid #333; }
.card h2 { margin: 0 0 10px 0; font-size: 14px; color: #888; }

textarea { width: 100%; height: 60px; background: #000; border: 1px solid #444; color: var(--accent); border-radius: 8px; padding: 10px; resize: none; font-family: monospace; font-size: 10px; }
button { width: 100%; padding: 15px; border-radius: 8px; border: none; background: var(--accent); color: #000; font-weight: bold; margin-top: 10px; font-size: 16px; cursor: pointer; }
button.secondary { background: #333; color: #fff; }

/* CHAT */
#chat-view { display: none; flex-direction: column; height: 100%; }
#msgs { flex: 1; overflow-y: auto; padding: 10px; }
.msg { padding: 8px 12px; border-radius: 8px; margin-bottom: 8px; font-size: 14px; width: fit-content; max-width: 80%; }
.msg.me { background: var(--accent); color: #000; align-self: flex-end; margin-left: auto; }
.msg.them { background: #333; color: #fff; }

.controls { display: flex; gap: 10px; padding: 10px; background: var(--panel); }
input { flex: 1; padding: 12px; border-radius: 8px; border: none; background: #000; color: #fff; }

.hidden { display: none !important; }
</style>
</head>
<body>

<header>
  <h1>TITANIUM</h1>
  <div id="status" class="status">DISCONNECTED</div>
</header>

<!-- CONNECTION SCREEN -->
<div id="setup-view" class="card" style="margin:20px;">
  <h2>1. MY STATIC CODE</h2>
  <textarea id="my-code" readonly onclick="this.select()"></textarea>
  <button class="secondary" onclick="copyCode()">Copy Code</button>

  <h2 style="margin-top:20px;">2. CONNECT TO PARTNER</h2>
  <textarea id="remote-code" placeholder="Paste Partner's Code Here..."></textarea>
  <button onclick="connect()">CONNECT</button>
  
  <p style="font-size:10px; color:#555; text-align:center; margin-top:10px;">
    Tip: Keep app open. The code will NOT change as long as the app is running.
  </p>
</div>

<!-- CHAT SCREEN -->
<div id="chat-view">
  <div id="msgs">
    <div style="text-align:center; color:#444; margin-top:50px">LINK ESTABLISHED</div>
  </div>
  <div class="controls">
    <button style="width:50px; margin:0; background:#333; color:#fff;" onclick="document.getElementById('f-in').click()">+</button>
    <input id="t-in" placeholder="Message..." onkeypress="if(event.key==='Enter') sendTxt()">
    <button style="width:60px; margin:0;" onclick="sendTxt()">Send</button>
  </div>
  <input type="file" id="f-in" class="hidden" onchange="sendFile()">
</div>

<script>
// --- SERVICE WORKER & WAKE LOCK ---
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js');
}

let wakeLock = null;
async function requestWakeLock() {
  try {
    wakeLock = await navigator.wakeLock.request('screen');
    console.log('Wake Lock Active');
  } catch (err) { console.log('Wake Lock Failed'); }
}
document.addEventListener('visibilitychange', () => {
  if (wakeLock !== null && document.visibilityState === 'visible') requestWakeLock();
});
requestWakeLock(); // Start immediately

// --- CORE LOGIC ---
const config = { iceServers: [] };
let pc, dc;

async function init() {
  pc = new RTCPeerConnection(config);
  dc = pc.createDataChannel("titanium");
  setupDC(dc);

  pc.onicecandidate = e => {
    if(!e.candidate) {
      const data = JSON.stringify(pc.localDescription);
      const compressed = LZString.compressToBase64(data);
      document.getElementById('my-code').value = compressed;
    }
  };
  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
}

async function connect() {
  const txt = document.getElementById('remote-code').value.trim();
  if(!txt) return alert("Paste code!");

  try {
    const desc = JSON.parse(LZString.decompressFromBase64(txt));
    if(!pc) init(); 
    
    await pc.setRemoteDescription(desc);

    if(desc.type === "offer") {
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
      alert("Answer Generated! Copy 'My Static Code' and send it back.");
    }
  } catch(e) { alert("Invalid Code"); }
}

function setupDC(chan) {
  dc = chan;
  dc.onopen = () => {
    document.getElementById('setup-view').classList.add('hidden');
    document.getElementById('chat-view').style.display = 'flex';
    document.getElementById('status').innerText = "ONLINE";
    document.getElementById('status').classList.add('online');
  };
  dc.onmessage = e => {
    const d = e.data;
    if(typeof d === 'string') {
      if(d.startsWith('data:')) renderImg(d, 'them');
      else renderMsg(d, 'them');
    }
  };
}

function copyCode() {
  document.getElementById('my-code').select();
  document.execCommand('copy');
  alert("Copied!");
}
function sendTxt() {
  const el = document.getElementById('t-in');
  if(el.value) { dc.send(el.value); renderMsg(el.value, 'me'); el.value=""; }
}
function sendFile() {
  const f = document.getElementById('f-in').files[0];
  const r = new FileReader();
  r.onload = e => { dc.send(e.target.result); renderImg(e.target.result, 'me'); };
  r.readAsDataURL(f);
}
function renderMsg(t, w) {
  const d = document.createElement('div');
  d.className = `msg ${w}`; d.innerText = t;
  document.getElementById('msgs').appendChild(d);
}
function renderImg(s, w) {
  const d = document.createElement('div');
  d.className = `msg ${w}`; d.innerHTML = `<img src="${s}" style="max-width:100%; border-radius:8px">`;
  document.getElementById('msgs').appendChild(d);
}

init();
</script>
</body>
</html>
